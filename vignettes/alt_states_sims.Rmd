---
title: "Alternative stable states simulations"
author: "Lucas A. Nell"
date: "10/25/2018"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Alternative stable states simulations}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "svglite", 
  fig.width = 6,
  fig.height = 4,
  echo = FALSE
)
knitr::opts_knit$set(root.dir = normalizePath(".."))
options(tibble.print_min = 4L, tibble.print_max = 8L)
```
```{r source_Rprofile, echo = FALSE}
if (!isTRUE(getOption('knitr.in.progress'))) source(".Rprofile")
suppressPackageStartupMessages({
    library(tidyverse)
    library(sauron)
})
```


```{r adaptive_dynamics}

q <- 3
n <- 1
args <- list(
    V0 = matrix(1, 1, q),
    N0 = rep(1, n),
    f = 0.1,  # cost of the trait on the growth rate
    g = 0.5,  # benefit of the trait on density dependence
    eta = 0.01,  # the non-additive effects of traits on `r`
    r0 = 0.5,
    d = -0.1,  # changes how the focal line is affected by other lines' trait values
    keep_pos = FALSE,
    max_t = 1e6,
    min_N = 1e-4,
    save_every = 100,
    show_progress = TRUE,
    mut_prob = 0.01,
    mut_sd = 0.75,
    max_clones = 1e4)
set.seed(4)
ad_sims <- do.call(adapt_dyn, args)

ad_sims %>%
    .[["data"]] %>% 
    ggplot(aes(time, V, color = trait)) +
    geom_point(shape = 1, alpha = 0.5) +
    scale_color_manual(values = c("dodgerblue3", "firebrick3", "black")) +
    ylab("Trait value") +
    xlab("Time")




# ad_sims %>% .[["data"]] %>% 
#     group_by(time) %>% 
#     summarize(N = n()) %>% 
#     ungroup() %>% 
#     ggplot(aes(time, N)) +
#     geom_line()



adp <- ad_sims %>%
    perturb(new_prop = 1,
            new_trait_means = c(1.09, 0.518, -1.61),
            new_trait_sigmas = rep(0.0, q),
            new_N_mean = 11.3 * 0.9, new_N_sd = 0) %>%
    perturb(new_prop = 1,
            new_trait_means = c(1.09, 0.518, -1.61),
            new_trait_sigmas = rep(0.0, q),
            new_N_mean = 11.3 * 1.1, new_N_sd = 0)

adp %>%
    .[["data"]] %>%
    ggplot(aes(time, V, color = trait)) +
    geom_vline(xintercept = args$max_t * 1:2, linetype = 2, color = "gray80") +
    geom_point(shape = 1, alpha = 0.5, size = 0.25) +
    scale_color_manual(values = c("dodgerblue3", "firebrick3", "gray60")) +
    # theme(legend.position = c(0.9, 0.5)) +
    guides(color = guide_legend("Trait:", override.aes = list(size = 2, alpha = 1))) +
    ylab("Trait value") +
    xlab("Time")




set.seed(5)
perterb_plot <- ad_sims %>%
    add_perterbation(new_prop = 5,
                     new_trait_means = c(0, 0),
                     new_trait_sigmas = rep(0.25, 2),
                     new_N_mean = 10, new_N_sd = 5) %>%
    add_perterbation(new_prop = 5,
                     new_trait_means = c(1.2, -1.6),
                     new_trait_sigmas = rep(0.25, 2),
                     new_N_mean = 100, new_N_sd = 5) %>%
    .[["data"]] %>%
    ggplot(aes(time, value, color = trait)) +
    geom_vline(xintercept = c(1e4, 2e4), linetype = 2, color = "gray80") +
    geom_point(shape = 1, alpha = 0.5, size = 0.25) +
    scale_color_manual(values = c("dodgerblue3", "firebrick3")) +
    theme(legend.position = c(0.9, 0.5)) +
    guides(color = guide_legend("Trait:", override.aes = list(size = 2, alpha = 1))) +
    ylab("Trait value") +
    xlab("Time")

perterb_plot <- perterb_plot +
    theme(axis.title = element_blank(),
          axis.ticks = element_blank(),
          axis.text = element_blank(),
          legend.position = "none")

perterb_plot

# ggsave(perterb_plot, filename = "perterb_p.pdf", width = 6.5, height = 4)




ad_sims %>% .[["data"]] %>% 
    group_by(time) %>% 
    summarize(N = sum(N)) %>% 
    ungroup() %>% 
    ggplot(aes(time, N)) +
    geom_line() +
    theme_classic()



```




