---
title: "Quantitative genetics - unstable states"
author: "Lucas A. Nell"
date: "`r Sys.setenv(TZ='America/Chicago'); format(Sys.Date(), '%d %b %Y')`"
output:
  github_document:
    toc: true
    toc_depth: 2
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "svglite", 
  fig.width = 6,
  fig.height = 4,
  echo = TRUE,
  eval = TRUE
)
knitr::opts_knit$set(root.dir = normalizePath(".."))
options(tibble.print_min = 4L, tibble.print_max = 8L)
```

```{r source_Rprofile, echo = FALSE}
if (!isTRUE(getOption('knitr.in.progress'))) source(".Rprofile")
```

```{r load_libs}
suppressPackageStartupMessages({
    library(tidyverse)
    library(sauron)
})
```


This document shows that when all lineages' traits are at zero, this is an unstable state:
The traits don't change without perturbation, but its primary eigenvalue is quite high
(>> 1).
The latter is what indicates instability.


## 2 traits

Objects to store the changes that occur and primary eigenvalues, respectively,
when all `V` are zero.

```{r unstable_zeros2-1}
unq_changes <- as.list(rep(NA, 9))
eigens <- numeric(9)
```

Setting default values across all `eta` and `d` values:

```{r unstable_zeros2-2}
q <- 2
n <- 100
args <- list(
    V = eval(formals(quant_gen)$V0),
    N = eval(formals(quant_gen)$N0),
    f = formals(quant_gen)$f,
    g = formals(quant_gen)$g,
    C = matrix(1, q, q),
    r0 = formals(quant_gen)$r0,
    d = 0,
    add_var = eval(formals(quant_gen)$add_var)
)
```

Now filling in the changes and eigenvalues for  all `eta` and `d` values:

```{r unstable_zeros2-3}
i <- 1
for (e in -1:1) {
    for (d in -1:1) {
        args_qg <- quant_gen_args(e, d, q)
        args$d <- args_qg$d
        args$C[lower.tri(args$C)] <- args_qg$eta
        args$C[upper.tri(args$C)] <- args_qg$eta
        changes <- do.call(sauron:::sel_str_cpp, 
                           args[names(args)[names(args) != "add_var"]])
        jc_mat <- do.call(sauron:::jacobian_cpp, 
                           args[names(args)[names(args) != "r0"]])
        unq_changes[[i]] <- unique(changes)
        eigens[i] <- Re(eigen(jc_mat, only.values = TRUE, 
                              symmetric = FALSE)$values[1])
        i <- i+1
    }
}
```

All unique trait changes across all simulations are below. They're obviously not changing.

```{r unstable_zeros2-4}
do.call(c, unq_changes)
```


Minimum and maximum primary eigenvalues show that these points are quite unstable.

```{r unstable_zeros2-5}
range(eigens)
```



## 3 traits

Same as above, but for 3 traits. I'll skip the commentary this time.


```{r unstable_zeros3}
unq_changes <- as.list(rep(NA, 9))
eigens <- numeric(9)

q <- 3
n <- 100
args <- list(
    V = eval(formals(quant_gen)$V0),
    N = eval(formals(quant_gen)$N0),
    f = formals(quant_gen)$f,
    g = formals(quant_gen)$g,
    C = matrix(1, q, q),
    r0 = formals(quant_gen)$r0,
    d = 0,
    add_var = eval(formals(quant_gen)$add_var)
)

i <- 1
for (e in -1:1) {
    for (d in -1:1) {
        args_qg <- quant_gen_args(e, d, q)
        args$d <- args_qg$d
        args$C[lower.tri(args$C)] <- args_qg$eta
        args$C[upper.tri(args$C)] <- args_qg$eta
        changes <- do.call(sauron:::sel_str_cpp, 
                           args[names(args)[names(args) != "add_var"]])
        jc_mat <- do.call(sauron:::jacobian_cpp, 
                           args[names(args)[names(args) != "r0"]])
        unq_changes[[i]] <- unique(changes)
        eigens[i] <- Re(eigen(jc_mat, only.values = TRUE, 
                              symmetric = FALSE)$values[1])
        i <- i+1
    }
}

do.call(c, unq_changes)
range(eigens)
```

For 3 traits, it's the same: it's an equilibrium, but a very unstable one.

