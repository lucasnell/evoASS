---
title: "Quantitative genetics results - changing `eta`"
author: "Lucas A. Nell"
date: "`r Sys.setenv(TZ='America/Chicago'); format(Sys.Date(), '%d %b %Y')`"
output:
  github_document:
    toc: true
    toc_depth: 2
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "png",
  fig.width = 6,
  fig.height = 4,
  echo = TRUE,
  eval = TRUE
)
knitr::opts_knit$set(root.dir = normalizePath(".."))
options(tibble.print_min = 4L, tibble.print_max = 8L)
```

```{r source_Rprofile, echo = FALSE}
if (!isTRUE(getOption('knitr.in.progress'))) source(".Rprofile")
```

```{r load-libs}
suppressPackageStartupMessages({
    library(tidyverse)
    library(sauron)
})
```


```{r stability-fxns, echo = FALSE}
# Jacobian for one simulation rep:
one_jacobian <- function(N, V, eta, d) {
    other_args <- c(list(eta = eta, d = d),
                    with(formals(quant_gen), {
                        list(f = f, g = g, add_var = eval(add_var))
                        }))
    args_ <- c(list(N = N, V = V),
               other_args[c("f", "g", "d", "add_var")])
    args_$add_var <- args_$add_var[1:length(N)]  # it's assumed they're all the same
    args_$C <- matrix(other_args$eta, length(V[[1]]), length(V[[1]]))
    diag(args_$C) <- 1
    jacobian_mat <- do.call(sauron:::jacobian_cpp, args_)
    return(jacobian_mat)
}
# Same but for a single `quant_gen` run of multiple reps:
jacobians <- function(sim_df_) {
    eta <- sim_df_$eta[[1]] %>% paste() %>% as.numeric()
    d <- sim_df_$d[[1]] %>% paste() %>% as.numeric()
    jc_mats <- sim_df_ %>%
        filter(time == max(time)) %>%
        group_by(rep, spp) %>%
        group_by(rep, spp) %>%
        summarize(N = N[[1]],
                  V = list(value)) %>%
        group_by(rep) %>%
        summarize(N = list(N),
                  V = list(V)) %>%
        ungroup() %>%
        mutate(jacobs = map2(N, V, ~ one_jacobian(.x, .y, eta, d))) %>%
        .[["jacobs"]]
    return(jc_mats)
}
# Vector of primary eigenvalues for a `quant_gen` run of multiple reps:
eigens <- function(sim_df_) {
    map_dbl(jacobians(sim_df_),
            ~ Re(eigen(.x, only.values = TRUE, 
                       symmetric = FALSE)$values[1]))
}
```



This document explores how changes in the `eta` parameter
(the tradeoff for diverging multiple traits)
affect patterns of evolutionary outcomes.
I'm particularly interested in the switch from points to a circle for two traits,
and from points to a ring to a shell in three traits.

## Transient dynamics

In this section I'm looking for trait changes through time as `eta` approaches zero
from either direction.

```{r}
from_zero <- c(1e-6, 1e-4)
n_ <- 20
# # Takes ~2 min
# t0 <- Sys.time()
# set.seed(689479082)
# sim_df <- pmap_dfr(as.list(expand.grid(.q = 2:3,
#                                        .e = c(-1 * rev(from_zero), 0, from_zero),
#                                        .d = -0.1)),
#                     function(.q, .e, .d) {
#                         qg_ <- quant_gen(eta = .e, d = .d, q = .q, n_cores = 4,
#                                          n = n_, n_reps = 20,
#                                          max_t = 2e6L, save_every = 1e3L,
#                                          show_progress = FALSE)
#                         cat(sprintf("%i %.2g \n", .q, .e))
#                         nv <- qg_$nv %>%
#                             mutate(eta = .e, d = .d, q = .q, trait = paste(trait))
#                         return(nv)
#                     }) %>%
#     select(eta, d, everything()) %>%
#     mutate_at(vars(eta, d, trait), factor) %>%
#     mutate(id = interaction(q, eta, d, rep, spp, trait))
# Sys.time() - t0; rm(t0)
# 
# saveRDS(sim_df, "results/quant_gen/eta-change-sims.rds")

sim_df <- readRDS("results/quant_gen/eta-change-sims.rds")

eigs <- sim_df %>%
    {expand.grid(q = unique(.$q), eta = levels(.$eta))} %>% 
    {map2_dfr(.$q, .$eta, 
             ~ tibble(q = .x, eta = .y , eigs = eigens(filter(sim_df, q == .x, eta == .y))))}

filter(sim_df, q == 2, eta == 1e-4) %>% 
    eigens()

# For 1 species and one trait, equilibrium N
Neq <- function(f, g, r0) (f / g) * exp((r0 - f) / f)
Neq(0.1, 0.5, 0.5)

sim_df %>% 
    filter(q == 2, trait == 1) %>% 
    filter(time == max(time)) %>% 
    group_by(eta, rep) %>% 
    .[["N"]] %>% 
    range()


test_df <- sim_df %>% 
    filter(q == 2) %>% 
    # mutate(id = interaction(q, eta, d, rep, spp)) %>%
    identity()


spp_counts <- test_df %>% 
    filter(trait == 1) %>% 
    group_by(q, eta, d, rep, time) %>% 
    summarize(n_spp = n()) %>% 
    ungroup()


test_df %>% 
    # filter(time <= 1e3) %>%
    ggplot(aes(time, value)) +
    geom_line(aes(group = id, color = trait), size = 0.25) +
    # geom_line(data = spp_counts, aes(y = (n_spp / n_) * 4 - 2)) +
    scale_color_viridis_d("Trait:", alpha = 0.75, end = 0.9, guide = FALSE) +
    # facet_wrap(~ eta, nrow = 2) +
    facet_grid( ~ eta) +
    # scale_x_continuous(breaks = c(0, 0.5e6, 1e6L), labels = c("0", "500e3", "1e6")) +
    # theme(strip.background = element_blank(),
    #       strip.text = element_blank(),
    #       axis.text = element_text(size = 8),
    #       axis.title = element_blank()) +
    NULL


test_df %>% 
    select(-id, -d) %>% 
    filter(time == max(time)) %>%
    mutate(trait = paste0("V", trait)) %>% 
    spread(trait, value) %>% 
    mutate(eig = map2_dbl(eta, rep, ~ eigs$eigs[eigs$q == 2 & eigs$eta == .x][.y]),
           eig_lgl = ifelse(eig < 1, 0, ifelse(eig == 1, 1, 2)) %>% 
               factor(levels = 0:2, labels = c("stable", "neutral", "unstable"))) %>% 
    ggplot(aes(V1, V2)) +
    # geom_point(aes(color = eig_lgl)) +
    geom_abline(slope = 1, intercept = 0, linetype = 3) +
    geom_abline(slope = -1, intercept = 0, linetype = 3) +
    geom_point(aes(color = eig)) +
    facet_grid( ~ eta) +
    # scale_color_manual(values = c("black", "dodgerblue", "firebrick")) +
    scale_color_gradient2(low = "dodgerblue", high = "firebrick", mid = "gray60", midpoint = 1) +
    NULL




test_df %>% 
    filter(trait == 1) %>% 
    # filter(time <= 10) %>%
    ggplot(aes(time, log(N))) +
    # ggplot(aes(time, N)) +
    geom_line(aes(group = id), size = 0.25, alpha = 0.4) +
    # facet_wrap(~ eta, nrow = 2) +
    facet_grid(~ eta) +
    # scale_x_continuous(breaks = c(0, 50e3, 100e3), labels = c("0", "50e3", "100e3")) +
    NULL


test_df %>% 
    # filter(rep == 1) %>% 
    mutate(trait = paste0("V", trait)) %>% 
    spread(trait, value) %>% 
    arrange(time) %>% 
    ggplot(aes(V1, V2)) +
    # geom_point(shape = 1) +
    geom_path(aes(group = id), alpha = 0.5) +
    facet_grid( ~ eta) +
    # scale_color_manual(values = c("black", "dodgerblue", "firebrick")) +
    scale_color_gradient2(low = "dodgerblue", high = "firebrick", mid = "gray60", midpoint = 1) +
    NULL




test_df %>% 
    group_by(eta, rep, time, spp, id) %>% 
    summarize(dist = sqrt(value[[1]]^2 + value[[2]]^2)) %>% 
    ungroup() %>% 
    arrange(time) %>% 
    ggplot(aes(time, dist)) +
    geom_path(aes(group = id), alpha = 0.5) +
    facet_grid( ~ eta) +
    NULL


C_ <- function(eta, q = 2) {
    cc <- matrix(eta, q, q)
    diag(cc) <- 1
    return(cc)
}

nspp <- 1
sauron:::sel_str_cpp(V = rep(list(cbind(1.4143019568, 1.4143019568)), nspp),
                      N = rep(10.9239992239, nspp),
                      f = 0.1,
                      g = 0.5,
                      C = C_(1e-4),
                      r0 = 0.5,
                      d = -0.1)


newqg <- map_dfr(c(1, -2),
                 function(.x) {
                     df_ <- quant_gen(eta = 1e-4, d = -0.1, q = 2,
                                      n = nspp,
                                      n_reps = 1,
                                      V0 = rep(list(cbind(rep(.x, 2))), nspp),
                                      N0 = rep(10.92, nspp),
                                      max_t = 1e5L, save_every = 1L, perturb_sd = 0,
                                      show_progress = FALSE)[["nv"]]
                     mutate(df_, start = .x)
    })

newqg2 <- map_dfr(c(1, -2),
                 function(.x) {
                     df_ <- quant_gen(eta = 1e-4, d = -0.1, q = 2,
                                      n = nspp,
                                      n_reps = 1,
                                      V0 = rep(list(cbind(c(0, 1e-2) + .x)), nspp),
                                      N0 = rep(10.92, nspp),
                                      max_t = 1e6L, save_every = 1e3L, perturb_sd = 0,
                                      show_progress = FALSE)[["nv"]]
                     mutate(df_, start = .x)
    })


newqg %>%
    filter(time == max(time)) %>% 
    group_by(start, trait) %>% 
    summarize(min = min(value),
              max = max(value))
newqg2 %>%
    filter(time == max(time)) %>% 
    group_by(start, trait) %>% 
    summarize(min = min(value),
              max = max(value))



newqg %>%
    # filter(time < 25) %>% 
    ggplot(aes(time, value)) +
    geom_line(aes(color = trait, group = interaction(start, trait))) +
    NULL

newqg2 %>%
    # filter(time < 25) %>% 
    ggplot(aes(time, value)) +
    geom_line(aes(color = trait, group = interaction(start, trait)), linetype = 2) +
    facet_wrap(~ factor(start) + trait) +
    NULL


newqg %>% 
    filter(time==max(time)) %>% 
    .[["N"]]

newqg %>% 
    mutate(trait = paste0("V", trait)) %>% 
    spread(trait, value) %>% 
    arrange(time) %>% 
    ggplot(aes(V1, V2)) +
    # geom_point(shape = 1) +
    geom_point(data = test_df %>% 
                   filter(time==max(time), eta==1e-4) %>% 
                   mutate(trait = paste0("V", trait)) %>% 
                   spread(trait, value) %>% 
                   arrange(time),
               alpha = 0.5, color = "firebrick") +
    geom_line(aes(group = factor(start))) +
    geom_point(data = newqg %>% 
                   filter(time==max(time)) %>% 
                   mutate(trait = paste0("V", trait)) %>% 
                   spread(trait, value) %>% 
                   arrange(time)) +
    scale_x_continuous(limits = c(-2, 2)) +
    scale_y_continuous(limits = c(-2, 2)) +
    scale_color_gradient2(low = "dodgerblue", high = "firebrick", mid = "gray60", midpoint = 1) +
    NULL

zz <- newqg2 %>% 
    mutate(trait = paste0("V", trait)) %>% 
    spread(trait, value) %>% 
    arrange(time)

zz %>% 
    arrange(time) %>% 
    ggplot(aes(V1, V2)) +
    geom_abline(slope = 1, intercept = 0, linetype = 3, color = "gray80") +
    # geom_point(shape = 1) +
    # geom_point(data = test_df %>% 
    #                filter(time==max(time), eta==1e-4) %>% 
    #                mutate(trait = paste0("V", trait)) %>% 
    #                spread(trait, value) %>% 
    #                arrange(time),
    #            alpha = 0.5, color = "firebrick") +
    geom_path(aes(group = factor(start))) +
    geom_point(data = zz %>% filter(time==max(time)), color = "red") +
    geom_point(data = zz %>% filter(time==min(time)), color = "red", shape = 4) +
    scale_color_gradient2(low = "dodgerblue", high = "firebrick", mid = "gray60", midpoint = 1) +
    NULL
    
sqrt(1.414125^2 + 1.414125^2)


sqrt(2)




with(list(f=0.1, g=0.5, eta=1e-4, Ni = 10.91526), {
    Vi <- rbind(c(-sqrt(2), sqrt(2)))
    exp(0.5 - f * Vi %*% C_(eta, 2) %*% t(Vi) - g * exp(- Vi %*% t(Vi)) * Ni)
}) %>% sprintf(fmt="%.10f")

with(list(f=0.1, g=0.5, eta=1e-4, Ni = 10.91526), {
    Vi <- rbind(c(-1.414125, 1.414125))
    exp(0.5 - f * Vi %*% C_(eta, 2) %*% t(Vi) - g * exp(- Vi %*% t(Vi)) * Ni)
}) %>% sprintf(fmt="%.10f")



F_ <- function(Vi, f, g, eta, Ni = 10.91526) {
    Vi <- rbind(c(-sqrt(2), Vi))
    exp(0.5 - f * Vi %*% C_(eta, 2) %*% t(Vi) - g * exp(- Vi %*% t(Vi)) * Ni)
}


{
    max_ <- 10
    curve(map_dbl(x, ~ F_(.x, 0.1, 0.5, 1e-4)), -max_, max_, n = 10001)
    abline(v = c(-1,1) * 1.414125, lty=3)
}


# ISSUE WITH BELOW: Ni is dependent on whether V1 = V2 or V1 = -V2
fitness <- function(V1, V2, eta, Ni, f = 0.1, g = 0.5, r0 = 0.5) {
    C <- matrix(eta, 2, 2)
    Vi <- cbind(V1, V2)
    diag(C) <- 1
    exp(r0 - f * Vi %*% C %*% t(Vi) - g * exp(- Vi %*% t(Vi)) * Ni)
}

# N at equilibrium
N_eq <- function(eta, f = 0.1, g = 0.5, r0 = 0.5) {
    rho <- ifelse(eta < 0, f * (1 + eta), f * (1 - eta))
    (rho / g) * exp((r0 / rho) - 1)
}
# Stable points:
stable_points <- function(eta, f = 0.1, g = 0.5, r0 = 0.5) {
    rho <- ifelse(eta < 0, f * (1 + eta), f * (1 - eta))
    xy <- c(-1, 1) * sqrt((r0 - rho) / (2 * rho))
    tibble(V1 = xy, V2 = xy)
}
# Unstable points:
unstable_points <- function(eta, f = 0.1, g = 0.5, r0 = 0.5) {
    rho <- ifelse(eta < 0, f * (1 - eta), f * (1 + eta))
    xy <- c(-1, 1) * sqrt((r0 - rho) / (2 * rho))
    tibble(V1 = xy, V2 = rev(xy))
}
max_mag <- 6
eta_ <- -0.6
crossing(V1 = seq(-max_mag, max_mag, 0.1), 
         V2 = seq(-max_mag, max_mag, 0.1),
         Ni = seq(0, N_eq(eta_), length.out = 4)) %>% 
    mutate(fit = pmap_dbl(list(V1, V2, Ni), ~ fitness(..1, ..2, eta = eta_, Ni = ..3))) %>% 
    mutate(Ni = factor(Ni, labels = c(0, sprintf("%i/3 Neq", 1:2), "Neq"))) %>% 
    ggplot(aes(V1, V2)) +
    geom_raster(aes(fill = fit), interpolate = FALSE) +
    geom_point(data = stable_points(eta_), color = "black") +
    geom_point(data = unstable_points(eta_), color = "black", shape = 1) +
    facet_wrap(~ Ni, nrow = 2) +
    scale_fill_gradient2(high = "firebrick", low = "dodgerblue3", mid = "white", midpoint = 1)




y <- quant_gen(eta = 0.01, d = -0.1, q = 2, n = 1, n_reps = 1,
               max_t = 2e6L, save_every = 1e3L, perturb_sd = 0,
               V0 = list(rbind(0, 1)),
               show_progress = TRUE)
z <- quant_gen(eta = 0.01, d = -0.1, q = 2, n = 1, n_reps = 1,
               g = 0.9,
               max_t = 2e6L, save_every = 1e3L, perturb_sd = 0,
               V0 = list(rbind(0, 1)),
               show_progress = TRUE)


y$nv %>%
    filter(time == max(time))
z$nv %>%
    filter(time == max(time))



```

