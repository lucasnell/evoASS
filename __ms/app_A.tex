\section*{Appendix A: Matrix derivatives in quantitative genetics equations}

\renewcommand{\thefigure}{A\arabic{figure}}
\renewcommand{\theequation}{A\arabic{equation}}
\renewcommand{\thetable}{A\arabic{table}}
\setcounter{equation}{0}
\setcounter{figure}{0}
\setcounter{table}{0}


As in the main text, $^{\textrm{T}}$ indicates transposition,
multiplication between matrices is always matrix multiplication, and
bold face indicates a matrix.
Also note that both $\mathbf{C}$ and $\mathbf{D}$ are symmetrical,
so $\mathbf{C} + \mathbf{C}^{\textrm{T}} = 2 \; \mathbf{C}$ and
$\mathbf{D} + \mathbf{D}^{\textrm{T}} = 2 \; \mathbf{D}$.


\subsection*{Trait change}

From the main text, we know that

\begin{equation*}
\begin{split}
    F_{i,t+1} &= \exp \left\{
        r_0 - f \; \mathbf{V}_{i,t} \; \mathbf{C} \; \mathbf{V}_{i,t}^{\textrm{T}} -
        \alpha_0 \;\textrm{e}^{- \mathbf{V}_{i,t} \mathbf{V}_{i,t}^{\textrm{T}} } \mathbf{\Omega}_{i,t}
        \right\} \\
    \mathbf{V}_{i,t+1} &= \mathbf{V}_{i,t} + \left( \frac{1}{F_{i,t+1}}
        \frac{\partial F_{i,t+1}}{\partial \mathbf{V}_{i,t}} \right) \sigma^2_i
    \textrm{.}
\end{split}
\end{equation*}


The partial derivative of fitness in relation to traits for species $i$ is


\begin{equation*}
\begin{split}
    \frac{\partial F_{i,t+1}}{\partial \mathbf{V}_{i,t}} &=
        \exp \left\{
            r_0
            - f \mathbf{V}_{i,t} \mathbf{C} \mathbf{V}_{i,t}^{\textrm{T}}
            - \alpha_0  \mathbf{\Omega}_{i,t} \,
                \textrm{e}^{- \mathbf{V}_{i,t} \mathbf{V}_{i,t}^{\textrm{T}}}
        \right\}
        \frac{\partial \!
            \left(
                r_0
                - f \; \mathbf{V}_{i,t} \; \mathbf{C} \; \mathbf{V}_{i,t}^{\textrm{T}}
                - \alpha_0 \; \mathbf{\Omega}_{i,t} \;
                    \textrm{e}^{- \mathbf{V}_{i,t} \mathbf{V}_{i,t}^{\textrm{T}}}
            \right)
            }{ \partial \mathbf{V}_{i,t} } \\
     &=
        \exp \left\{
            r_0
            - f \mathbf{V}_{i,t} \mathbf{C} \mathbf{V}_{i,t}^{\textrm{T}}
            - \alpha_0  \mathbf{\Omega}_{i,t} \,
                \textrm{e}^{- \mathbf{V}_{i,t} \mathbf{V}_{i,t}^{\textrm{T}}}
        \right\}
        \left[
            - 2 f \mathbf{V}_{i,t} \mathbf{C}
            - \alpha_0 \, \mathbf{\Omega}_{i,t} \,
                \textrm{e}^{- \mathbf{V}_{i,t} \mathbf{V}_{i,t}^{\textrm{T}}} \:
                \frac{\partial \! \left( - \mathbf{V}_{i,t} \mathbf{V}_{i,t}^{\textrm{T}} \right)
                    }{ \partial \mathbf{V}_{i,t} }
        \right] \\[2ex]
    \frac{ \partial F_{i,t} }{ \partial \mathbf{V}_{i,t} } &=
        \exp \left\{
            r_0
            - f \mathbf{V}_{i,t} \mathbf{C} \mathbf{V}_{i,t}^{\textrm{T}}
            - \alpha_0  \mathbf{\Omega}_{i,t} \,
                \textrm{e}^{- \mathbf{V}_{i,t} \mathbf{V}_{i,t}^{\textrm{T}}}
        \right\}
        \left[
            2 \alpha_0 \mathbf{\Omega}_{i,t} \,
                \textrm{e}^{- \mathbf{V}_{i,t} \mathbf{V}_{i,t}^{\textrm{T}}} \:
                \mathbf{V}_{i,t}
            - 2 f \mathbf{V}_{i,t} \mathbf{C}
        \right]
    \textrm{.}
\end{split}
\end{equation*}



Combining above with equation \ref{eq:trait-change}, we find that trait values at
time $t+1$ are

\begin{equation} \label{eq:trait-change-full}
    \mathbf{V}_{i,t+1} = \mathbf{V}_{i,t} + 2 \sigma_i^2
    \left(
        \alpha_0 \mathbf{\Omega}_{i,t} \,
            \textrm{e}^{- \mathbf{V}_{i,t} \mathbf{V}_{i,t}^{\textrm{T}}} \:
            \mathbf{V}_{i,t}
        - f \mathbf{V}_{i,t} \mathbf{C}
    \right)
    \textrm{.}
\end{equation}


\subsection*{Jacobian matrix}

The $nq \times nq$ Jacobian matrix consists of $n^2$ inner $q \times q$ blocks.
The on-diagonal blocks are the partial derivatives of species $i$ traits at time $t+1$ with respect
to species $i$ traits at time $t$:

\begin{equation*}
\begin{split}
    \frac{ \partial \; \mathbf{V}_{i,t+1} }{ \partial \; \mathbf{V}_{i,t} } &=
        \frac{ \partial \; \mathbf{V}_{i,t} }{ \partial \; \mathbf{V}_{i,t} } +
        2 \; \sigma_i^2
        \left(
            \frac{ \partial \;
                \alpha_0 \; \mathbf{\Omega}_{i,t} \;
                    \textrm{e}^{-\mathbf{V}_{i,t} \mathbf{V}_{i,t}^\textrm{T}} \,
                    \mathbf{V}_{i,t}}{\partial \; \mathbf{V}_{i,t} } -
            \frac{ \partial \; f \, \mathbf{V}_{i,t} \mathbf{C}}{\partial \; \mathbf{V}_{i,t} }
        \right) \\
    &=
        \mathbf{I} +
        2 \; \sigma_i^2
        \left[
            \alpha_0 \; \mathbf{\Omega}_{i,t} \,
            \left(
                \textrm{e}^{-\mathbf{V}_{i,t} \mathbf{V}_{i,t}^\textrm{T}} \: \mathbf{I} +
                \frac{ \partial \;
                        \textrm{e}^{-\mathbf{V}_{i,t} \mathbf{V}_{i,t}^\textrm{T}}
                        }{\partial \; \mathbf{V}_{i,t} } \, \mathbf{V}_{i,t}
            \right) -
            f \, \mathbf{C}
            \right] \\[2ex]
    \frac{ \partial \; \mathbf{V}_{i,t+1} }{ \partial \; \mathbf{V}_{i,t} } &= \mathbf{I} +
        2 \; \sigma_i^2 \;
        \left[
            \alpha_0 \; \mathbf{\Omega}_{i,t} \;
            \textrm{e}^{ - \mathbf{V}_{i,t} \mathbf{V}_{i,t}^{\textrm{T}} }
            \left(
                \mathbf{I} - 2 \; \mathbf{V}_{i,t}^{\textrm{T}} \mathbf{V}_{i,t}
            \right) -
            f \, \mathbf{C}
        \right]
    \textrm{,}
\end{split}
\end{equation*}

\noindent where $\mathbf{I}$ is a $q \times q$ identity matrix.


The off-diagonal blocks of the Jacobian are the partial derivatives of species $i$
traits at time $t+1$ with respect to species $k$ traits at time $t$, where $k \ne i$.
To calculate this, it's useful to rearrange equation \ref{eq:trait-change-full} and
extract the portion that includes $\mathbf{V}_{k,t}$:

\begin{equation*}
\begin{split}
    \mathbf{V}_{i,t+1} &= \mathbf{V}_{i,t} + 2 \; \sigma_i^2
    \left[
        \left(
            N_{k,t} \; \textrm{e}^{-\mathbf{V}_{k,t} \mathbf{D} \mathbf{V}_{k,t}^\textrm{T}} +
            \mathbf{\Phi}_{i,t}
        \right)
        \left(
            \alpha_0 \; \textrm{e}^{-\mathbf{V}_{i,t}
            \mathbf{V}_{i,t}^\textrm{T}} \; \mathbf{V}_{i,t}
        \right)
        - f \mathbf{V}_{i,t} \mathbf{C}
    \right] \\
    \mathbf{\Phi}_{i,t} &= N_{i,t} + \sum_{j \ne i, j \ne k}^{n}{
        N_{j,t} \; \textrm{e}^{- \mathbf{V}_{j,t} \mathbf{D}
        \mathbf{V}_{j,t}^{\textrm{T}}} }
    \textrm{.}
\end{split}
\end{equation*}

From this we calculated the partial derivative of $\mathbf{V}_{i,t+1}$ in relation to
$\mathbf{V}_{k,t}$


\begin{equation*}
\begin{split}
    \frac{ \partial \: \mathbf{V}_{i,t+1} }{ \partial \: \mathbf{V}_{k,t} } &=
        \frac{ \partial \: \mathbf{V}_{i,t} }{ \partial \: \mathbf{V}_{k,t} } +
        2 \; \sigma_i^2 \;
        \left[
            \frac{ \partial \:
                \left(
                    N_{k,t} \textrm{e}^{- \mathbf{V}_{k,t} \mathbf{D}
                    \mathbf{V}_{k,t}^{\textrm{T}}} + \mathbf{\Phi}_{i,t}
                \right)
                \left(
                    \alpha_0 \; \textrm{e}^{- \mathbf{V}_{i,t}
                    \mathbf{V}_{i,t}^{\textrm{T}}} \mathbf{V}_{i,t}
                \right)
            }{ \partial \:  \mathbf{V}_{k,t} } -
            \frac{ \partial \:  f \, \mathbf{V}_{i,t} \mathbf{C} }{
            \partial \: \mathbf{V}_{k,t} }
        \right] \\
    &= 2 \; \sigma_i^2 \; \alpha_0 \; N_{k,t} \;
        \frac{ \partial \:
                \textrm{e}^{
                    - \mathbf{V}_{k,t} \mathbf{D} \mathbf{V}_{k,t}^{\textrm{T}}
                    - \mathbf{V}_{i,t} \mathbf{V}_{i,t}^{\textrm{T}}
                } \; \mathbf{V}_{i,t}
            }{ \partial \:  \mathbf{V}_{k,t} } \\
    &= 2 \; \sigma_i^2 \; \alpha_0 \; N_{k,t} \;
        \frac{ \partial \:
                \left(
                    - \mathbf{V}_{k,t} \mathbf{D} \mathbf{V}_{k,t}^{\textrm{T}}
                    - \mathbf{V}_{i,t} \mathbf{V}_{i,t}^{\textrm{T}}
                \right)
            }{ \partial \:  \mathbf{V}_{k,t} } \;
        \textrm{e}^{
                    - \mathbf{V}_{k,t} \mathbf{D} \mathbf{V}_{k,t}^{\textrm{T}}
                    - \mathbf{V}_{i,t} \mathbf{V}_{i,t}^{\textrm{T}}
                } \; \mathbf{V}_{i,t} \\
    &= - 2 \; \sigma_i^2 \; \alpha_0 \; N_{k,t} \,
        \left( \mathbf{D} + \mathbf{D}^{\textrm{T}} \right) \,
        \mathbf{V}_{k,t}^{\textrm{T}} \;
        \textrm{e}^{
                    - \mathbf{V}_{k,t} \mathbf{D} \mathbf{V}_{k,t}^{\textrm{T}}
                    - \mathbf{V}_{i,t} \mathbf{V}_{i,t}^{\textrm{T}}
                } \; \mathbf{V}_{i,t} \\[2ex]
    \frac{ \partial \: \mathbf{V}_{i,t+1} }{ \partial \: \mathbf{V}_{k,t}} &=
        -4 \; \sigma_i^2 \; \alpha_0 \; N_{k,t} \;
        \mathbf{D} \; \mathbf{V}_{k,t}^{\textrm{T}} \;
        \textrm{e}^{
                - \mathbf{V}_{k,t} \mathbf{D} \mathbf{V}_{k,t}^{\textrm{T}}
                - \mathbf{V}_{i,t} \mathbf{V}_{i,t}^{\textrm{T}}
            } \;
            \mathbf{V}_{i,t}
    \textrm{.} \\
\end{split}
\end{equation*}



